<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>F1 Course Simulation | Curriculum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+Sinhala:wght@400;700;900&display=swap');

        :root {
            --f1-red: #e10600;
            --f1-black: #050505;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Orbitron', 'Noto Sans Sinhala', sans-serif;
            background-color: var(--f1-black);
            color: white;
            min-height: 100vh;
        }

        .f1-border-bottom {
            border-bottom: 4px solid var(--f1-red);
            clip-path: polygon(0 0, 100% 0, 98% 100%, 0% 100%);
        }

        .section-header {
            background: linear-gradient(90deg, #1a1a1a 0%, transparent 100%);
            border-left: 3px solid var(--f1-red);
            padding: 8px 15px;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }

        .module-card {
            background: #0d0d0d;
            border: 1px solid #1a1a1a;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .module-card:hover {
            border-color: var(--f1-red);
            background: #111;
            transform: translateX(5px);
        }

        .type-badge {
            font-size: 8px;
            padding: 2px 8px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 2px;
        }

        .btn-back {
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #666;
            transition: color 0.2s;
        }

        .btn-back:hover { color: var(--f1-red); }

        .loading-screen {
            position: fixed;
            inset: 0;
            background: black;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s;
        }

        @keyframes scan {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }
        .scanner {
            position: absolute;
            width: 100%;
            height: 2px;
            background: var(--f1-red);
            box-shadow: 0 0 15px var(--f1-red);
            animation: scan 2s linear infinite;
            opacity: 0.3;
        }
    </style>
</head>
<body>

    <div id="loading" class="loading-screen">
        <div class="scanner"></div>
        <div class="text-center">
            <h1 class="text-xl font-black italic tracking-tighter uppercase">Initializing <span class="text-red-600">Curriculum</span></h1>
            <div class="mt-4 w-48 h-1 bg-zinc-800 mx-auto overflow-hidden">
                <div class="h-full bg-red-600" style="width: 30%"></div>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto p-4 md:p-8">
        <!-- Header Navigation -->
        <nav class="flex items-center justify-between mb-8">
            <a href="dashboard.html" class="btn-back flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                Paddock Dashboard
            </a>
            <div class="text-right">
                <p class="text-[8px] text-red-600 font-black tracking-widest uppercase">Encryption Active</p>
                <p class="text-[10px] font-bold" id="sim-time">00:00:00</p>
            </div>
        </nav>

        <!-- Course Identity -->
        <header class="mb-8">
            <div class="f1-border-bottom pb-4 mb-4">
                <p id="course-id-label" class="text-[10px] text-gray-500 font-black tracking-[4px] uppercase">COURSE_ID: NULL</p>
                <h1 id="course-title" class="text-3xl md:text-5xl font-black italic uppercase tracking-tighter">LOADING...</h1>
            </div>
            <div class="flex flex-wrap gap-4 text-[9px] font-bold uppercase tracking-widest text-gray-400">
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-500"></span> Simulator Online</span>
                <span class="flex items-center gap-1" id="module-count">0 Lessons Available</span>
            </div>
        </header>

        <!-- Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <div id="curriculum-content" class="space-y-2">
                    <!-- Data injected here -->
                </div>
            </div>

            <div class="space-y-6">
                <div class="bg-zinc-900/30 p-6 border border-zinc-800">
                    <h3 class="text-[10px] font-black uppercase mb-4 tracking-widest text-red-600">Telemetry Info</h3>
                    <div class="space-y-4">
                        <div>
                            <p class="text-[8px] uppercase text-zinc-500 font-bold mb-1">Status</p>
                            <p class="text-[10px] font-black italic">Bypassed Login</p>
                        </div>
                        <div>
                            <p class="text-[8px] uppercase text-zinc-500 font-bold mb-1">Last Update</p>
                            <p class="text-[10px] font-black italic uppercase" id="update-stamp">Real-time sync</p>
                        </div>
                    </div>
                </div>

                <div class="bg-zinc-900/10 p-4 border-l-2 border-zinc-800 italic">
                    <p class="text-[10px] text-zinc-500 leading-relaxed">
                        Lessons are filtered by Section and automatically archived after the expiration date listed in Column I of the master database.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_SHEET_ID = '1HLQxJv32eo-EloTtdZhw5ZhEWIXuhMOI7OAKsqG-dfI';
        const GOOGLE_API_KEY = 'AIzaSyD3sts8y_s8M8L2Y66Gz0ICY_9SY-VmoEo';
        const CURRICULUM_SHEET = 'curriculum'; 

        const courseId = localStorage.getItem('selectedCourseId') || 'DEMO';
        const courseName = localStorage.getItem('selectedCourseName') || 'Standard Simulation';

        async function initPage() {
            document.getElementById('course-id-label').innerText = `COURSE_ID: ${courseId}`;
            document.getElementById('course-title').innerText = courseName;
            
            startTimeDisplay();
            await fetchAndRenderCurriculum();
            
            setTimeout(() => {
                const loader = document.getElementById('loading');
                if (loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.style.display = 'none', 500);
                }
            }, 800);
        }

        async function fetchAndRenderCurriculum() {
            const container = document.getElementById('curriculum-content');
            try {
                // Fetch Range A:J
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEET_ID}/values/${CURRICULUM_SHEET}!A2:J200?key=${GOOGLE_API_KEY}`);
                const data = await response.json();
                
                if (!data.values) {
                    container.innerHTML = `<p class="text-zinc-600 text-xs italic">No simulation data received.</p>`;
                    return;
                }

                const today = new Date();
                today.setHours(0,0,0,0);

                // Filter by Course ID (A) and Expiry Date (I)
                const validRows = data.values.filter(row => {
                    const rowCourseId = row[0]; // A
                    const expiryStr = row[8];   // I: Ending Date (day/month/year)
                    
                    if (rowCourseId !== courseId) return false;

                    if (expiryStr) {
                        const [day, month, year] = expiryStr.split('/').map(Number);
                        const expiryDate = new Date(year, month - 1, day);
                        if (today > expiryDate) return false;
                    }
                    return true;
                });

                document.getElementById('module-count').innerText = `${validRows.length} Lessons Available`;

                if (validRows.length === 0) {
                    container.innerHTML = `<p class="text-zinc-500 text-xs italic p-10 text-center border border-dashed border-zinc-800 uppercase tracking-widest">No Active Lessons in Paddock</p>`;
                    return;
                }

                // Group by Section Name (C)
                const sections = {};
                validRows.forEach(row => {
                    const sectionName = row[2] || "Unassigned Section"; 
                    if (!sections[sectionName]) sections[sectionName] = [];
                    sections[sectionName].push(row);
                });

                container.innerHTML = '';
                for (const sectionName in sections) {
                    // Section Header
                    const secHeader = document.createElement('div');
                    secHeader.className = 'section-header';
                    secHeader.innerHTML = `<h3 class="text-[10px] font-black uppercase tracking-[3px] text-zinc-400">${sectionName}</h3>`;
                    container.appendChild(secHeader);

                    // Lessons in Section
                    sections[sectionName].forEach(row => {
                        // A: CourseID, B: LessonID, C: Section, D: LessonName, E: Type, F: URL, G: Resource, H: Start, I: End, J: Week
                        const lessonId = row[1];
                        const lessonName = row[3];
                        const type = (row[4] || '').trim().toLowerCase();
                        const week = row[9] ? `WEEK ${row[9]}` : '';

                        let targetUrl = '#';
                        if (type.includes('youtube')) {
                            targetUrl = `learn.html?id=${lessonId}`;
                        } else if (type.includes('zoom')) {
                            targetUrl = `learnzoom.html?id=${lessonId}`;
                        }

                        const card = document.createElement('div');
                        card.className = 'module-card p-4 flex items-center justify-between group mb-2';
                        card.onclick = () => window.location.href = targetUrl;
                        
                        card.innerHTML = `
                            <div class="flex items-center gap-4">
                                <div class="w-1 h-8 bg-zinc-800 group-hover:bg-red-600 transition-colors"></div>
                                <div>
                                    <h4 class="text-[11px] font-black uppercase tracking-tight text-zinc-200 group-hover:text-white">${lessonName}</h4>
                                    <div class="flex items-center gap-2 mt-1">
                                        <span class="type-badge ${type.includes('youtube') ? 'bg-red-900/20 text-red-500 border border-red-900/50' : 'bg-blue-900/20 text-blue-500 border border-blue-900/50'}">${type}</span>
                                        <span class="text-[8px] text-zinc-600 font-bold uppercase">${week}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="opacity-0 group-hover:opacity-100 transition-all transform translate-x-2 group-hover:translate-x-0 text-red-600">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                }

            } catch (err) {
                console.error(err);
                container.innerHTML = `<p class="text-red-600 text-[10px] font-bold uppercase tracking-widest text-center py-10">Data Pipeline Error</p>`;
            }
        }

        function startTimeDisplay() {
            setInterval(() => {
                document.getElementById('sim-time').innerText = new Date().toLocaleTimeString('en-GB', { hour12: false });
            }, 1000);
        }

        window.addEventListener('load', initPage);
    </script>
</body>
</html>
