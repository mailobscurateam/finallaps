<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Hub - Course Curriculum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+Sinhala:wght@400;700;900&display=swap');

        :root {
            --f1-red: #e10600;
            --f1-black: #050505;
            --f1-dark: #111111;
        }

        body {
            background-color: var(--f1-black);
            color: white;
            font-family: 'Orbitron', 'Noto Sans Sinhala', sans-serif;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        .f1-border-bottom {
            border-bottom: 1px solid #222;
        }

        /* Responsive Grid Background */
        .grid-bg {
            background-image: radial-gradient(#222 1px, transparent 1px);
            background-size: 20px 20px;
        }
        @media (min-width: 768px) {
            .grid-bg { background-size: 30px 30px; }
        }

        /* Course Card Optimization */
        .course-card {
            background: #0a0a0a;
            border: 1px solid #1a1a1a;
            transition: transform 0.2s ease, border-color 0.2s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
            cursor: pointer;
        }

        @media (hover: hover) {
            .course-card:hover {
                border-color: var(--f1-red);
                transform: translateY(-4px);
                background: #111;
            }
        }

        .course-card:active {
            transform: scale(0.98);
            background: #111;
        }

        .tag {
            font-size: 8px;
            font-weight: 900;
            text-transform: uppercase;
            padding: 2px 6px;
            background: #1a1a1a;
            border: 1px solid #333;
            white-space: nowrap;
        }

        .lesson-type-tag, .zoom-tag {
            font-size: 9px;
            font-weight: 900;
            padding: 2px 12px;
            clip-path: polygon(10% 0, 100% 0, 90% 100%, 0% 100%);
            text-transform: uppercase;
            font-style: italic;
        }

        .lesson-type-tag { background: var(--f1-red); }
        .zoom-tag { background: #2D8CFF; }

        .section-header {
            border-left: 4px solid var(--f1-red);
            padding-left: 0.75rem;
            margin-top: 2rem;
            margin-bottom: 1rem;
        }

        .nav-link {
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #71717a;
            transition: color 0.3s;
        }

        .nav-link.active { color: var(--f1-red); }

        .user-pill {
            background: #111;
            border: 1px solid #222;
            padding: 4px 12px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--f1-red); }
    </style>
</head>
<body class="grid-bg pb-10">

    <nav class="f1-border-bottom bg-black/90 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3 sm:py-4 flex justify-between items-center">
            <div class="flex items-center gap-4 sm:gap-8">
                <h1 class="text-lg sm:text-xl font-black italic tracking-tighter">F1 <span class="text-red-600">HUB</span></h1>
                <div class="flex gap-4 sm:gap-6">
                    <a href="dashboard.html" class="nav-link">Stats</a>
                    <a href="courses.html" class="nav-link active">Drive</a>
                </div>
            </div>
            
            <!-- Authenticated User Section -->
            <div id="auth-section" class="flex items-center gap-3">
                <div class="user-pill hidden sm:flex">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    <div class="flex flex-col">
                        <span id="user-name" class="text-[9px] font-black uppercase text-white leading-none">Driver</span>
                        <span id="user-id-display" class="text-[7px] font-bold text-zinc-500 uppercase tracking-widest">ID: 0000</span>
                    </div>
                </div>
                <button onclick="logout()" class="text-[9px] font-black text-zinc-500 hover:text-red-600 uppercase tracking-widest transition-colors">
                    Exit
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-6 sm:py-12">
        <header class="mb-8 sm:mb-14">
            <div class="flex items-center gap-2 mb-2 sm:mb-3">
                <div class="w-6 sm:w-10 h-[2px] bg-red-600"></div>
                <span class="text-red-600 text-[9px] sm:text-xs font-black uppercase tracking-[0.2em] sm:tracking-[0.4em]">Curriculum Intelligence</span>
            </div>
            <h2 id="course-title" class="text-3xl sm:text-5xl md:text-6xl font-black italic uppercase tracking-tighter mb-3 sm:mb-5 leading-none">
                SIMULATION DATA
            </h2>
            <p id="course-desc" class="text-zinc-500 max-w-2xl text-xs sm:text-sm leading-relaxed">
                Syncing with race control for local track data...
            </p>
        </header>

        <div id="sections-container" class="space-y-10 sm:space-y-16">
            <!-- Loader -->
            <div class="flex flex-col items-center justify-center py-20 text-zinc-700">
                <div class="w-10 h-10 border-2 border-zinc-800 border-t-red-600 rounded-full animate-spin mb-4"></div>
                <p class="text-[9px] font-black uppercase tracking-widest">Initialising Sector Profiles...</p>
            </div>
        </div>
    </main>

    <script>
        const GOOGLE_SHEET_ID = '1HLQxJv32eo-EloTtdZhw5ZhEWIXuhMOI7OAKsqG-dfI';
        const GOOGLE_API_KEY = 'AIzaSyD3sts8y_s8M8L2Y66Gz0ICY_9SY-VmoEo';
        const LESSONS_SHEET = 'lessons';
        const COURSES_SHEET = 'courses';

        const urlParams = new URLSearchParams(window.location.search);
        const activeCourseId = urlParams.get('id') || 'Finallaps';

        // AUTHENTICATION CHECK
        function checkAuth() {
            const userData = localStorage.getItem('f1_user');
            if (!userData) {
                // Redirect to login if no session found
                window.location.href = 'index.html';
                return;
            }
            const user = JSON.parse(userData);
            document.getElementById('user-name').innerText = user.name || 'Driver';
            document.getElementById('user-id-display').innerText = `ID: ${user.id || 'N/A'}`;
        }

        function logout() {
            localStorage.removeItem('f1_user');
            window.location.href = 'index.html';
        }

        async function fetchCurriculum() {
            try {
                // Fetch Course Meta
                const metaRes = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEET_ID}/values/${COURSES_SHEET}!A2:C100?key=${GOOGLE_API_KEY}`);
                const metaData = await metaRes.json();
                const courseMeta = metaData.values?.find(row => row[0] === activeCourseId);

                if (courseMeta) {
                    document.getElementById('course-title').innerText = courseMeta[1].toUpperCase();
                    document.getElementById('course-desc').innerText = courseMeta[2];
                }

                // Fetch Lessons
                const lessonsRes = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEET_ID}/values/${LESSONS_SHEET}!A2:J500?key=${GOOGLE_API_KEY}`);
                const lessonsData = await lessonsRes.json();

                if (lessonsData.values) {
                    const filteredLessons = lessonsData.values.filter(row => row[0] === activeCourseId);
                    renderGroupedLessons(filteredLessons);
                }
            } catch (err) {
                console.error("Link failure:", err);
                document.getElementById('sections-container').innerHTML = `<p class="text-center text-red-600 font-bold uppercase py-10">Telemetry Lost - Check Connection</p>`;
            }
        }

        function renderGroupedLessons(lessons) {
            const container = document.getElementById('sections-container');
            container.innerHTML = '';

            const grouped = lessons.reduce((acc, lesson) => {
                const sectionName = lesson[2] || "Uncategorized";
                if (!acc[sectionName]) acc[sectionName] = [];
                acc[sectionName].push(lesson);
                return acc;
            }, {});

            Object.keys(grouped).forEach(sectionName => {
                const sectionLessons = grouped[sectionName];
                
                const sectionWrapper = document.createElement('div');
                sectionWrapper.className = "fade-in";
                sectionWrapper.innerHTML = `
                    <div class="section-header">
                        <h3 class="text-[10px] sm:text-xs font-black text-red-600 uppercase tracking-[0.2em] sm:tracking-[0.4em]">
                            Sector: ${sectionName}
                        </h3>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                        ${sectionLessons.map(lesson => renderLessonCard(lesson)).join('')}
                    </div>
                `;
                container.appendChild(sectionWrapper);
            });
        }

        function renderLessonCard(lesson) {
            const lessonId = lesson[1] || '';
            const lessonTypeRaw = lesson[4] || 'Video';
            const lessonType = lessonTypeRaw.toLowerCase();
            const isZoom = lessonType.includes('zoom');
            
            const escapedLessonId = lessonId.replace(/'/g, "\\'");
            const escapedLessonType = lessonType.replace(/'/g, "\\'");

            return `
                <div class="course-card p-4 sm:p-6" onclick="navigateToLesson('${escapedLessonId}', '${escapedLessonType}')">
                    <div class="flex-grow">
                        <div class="flex justify-between items-start mb-4 sm:mb-6">
                            <span class="tag">ID: ${lessonId}</span>
                            <span class="${isZoom ? 'zoom-tag' : 'lesson-type-tag'}">
                                ${lessonTypeRaw}
                            </span>
                        </div>
                        <h3 class="text-lg sm:text-xl font-black italic uppercase tracking-tight mb-2 leading-tight">
                            ${lesson[3]}
                        </h3>
                        <p class="text-zinc-500 text-[10px] sm:text-xs line-clamp-3 mb-4 font-sans">
                            ${lesson[6] || 'No further data available for this sector simulation.'}
                        </p>
                    </div>
                    <div class="flex items-center justify-between mt-auto pt-4 border-t border-white/5">
                        <span class="text-[8px] sm:text-[9px] font-bold text-zinc-600 uppercase tracking-widest">
                            Mode: ${lessonTypeRaw}
                        </span>
                        <div class="text-red-600">
                            <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            `;
        }

        function navigateToLesson(lessonId, type) {
            if (!lessonId) return;
            
            let destination = 'learn.html'; 
            if (type.includes('zoom')) {
                destination = 'learnzoom.html';
            }

            const url = `${destination}?course=${encodeURIComponent(activeCourseId)}&lesson=${encodeURIComponent(lessonId)}`;
            window.location.href = url;
        }

        // Initialize
        checkAuth();
        fetchCurriculum();
    </script>
</body>
</html>
