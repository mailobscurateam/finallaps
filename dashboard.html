<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>F1 Driver Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.0/dist/umd/supabase.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+Sinhala:wght@400;700;900&display=swap');

        :root {
            --f1-red: #e10600;
            --f1-black: #050505;
            --sidebar-width: 260px;
        }

        [v-cloak] { display: none; }
        body.loading { visibility: hidden; }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Orbitron', 'Noto Sans Sinhala', sans-serif;
            background-color: var(--f1-black);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- NAVIGATION --- */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            background: #000;
            border-right: 1px solid #222;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            color: #666;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }

        .sidebar-item:hover, .sidebar-item.active {
            color: white;
            background: rgba(225, 6, 0, 0.08);
            border-left-color: var(--f1-red);
        }

        .main-content {
            margin-left: var(--sidebar-width);
            padding: 2rem;
            min-height: 100vh;
        }

        /* --- CARDS & UI ELEMENTS --- */
        .card {
            background: #0d0d0d;
            border: 1px solid #1a1a1a;
            padding: 1.5rem;
            border-radius: 4px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover { border-color: #333; }

        .course-card {
            background: #0d0d0d;
            border: 1px solid #1a1a1a;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .course-img-container {
            position: relative;
            width: 100%;
            height: 160px;
            overflow: hidden;
        }

        .course-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .course-card:hover .course-img { transform: scale(1.05); }

        .f1-btn {
            background: #1a1a1a;
            color: white;
            padding: 0.8rem;
            text-align: center;
            font-size: 0.7rem;
            font-weight: 900;
            text-transform: uppercase;
            transition: all 0.2s;
            clip-path: polygon(4% 0, 100% 0, 96% 100%, 0% 100%);
            width: 100%;
        }

        .f1-btn:hover {
            background: var(--f1-red);
            transform: skewX(-2deg);
        }

        /* --- MOBILE OPTIMIZATIONS --- */
        @media (max-width: 1024px) {
            .sidebar { width: 80px; }
            .sidebar .label, .sidebar h1, .sidebar p { display: none; }
            .sidebar-item { justify-content: center; padding: 1.5rem 0; }
            .sidebar-item svg { margin-right: 0; width: 22px; height: 22px; }
            .main-content { margin-left: 80px; padding: 1.5rem; }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: 64px;
                flex-direction: row;
                bottom: 0;
                top: auto;
                border-right: none;
                border-top: 1px solid #222;
                justify-content: space-around;
                padding: 0 10px;
            }
            .sidebar-item {
                flex-direction: column;
                border-left: none;
                border-bottom: 3px solid transparent;
                padding: 0.5rem 0;
                flex: 1;
                font-size: 0.6rem;
                gap: 4px;
            }
            .sidebar-item.active { border-bottom-color: var(--f1-red); border-left-color: transparent; }
            .main-content { margin-left: 0; padding: 1rem 1rem 80px 1rem; }
            .stat-value { font-size: 1.5rem !important; }
            header h2 { font-size: 1.5rem !important; }
        }

        /* --- UTILS --- */
        .view-section { display: none; animation: fadeIn 0.3s ease-out; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        #toast {
            position: fixed;
            top: 1.5rem;
            left: 50%;
            transform: translateX(-50%) translateY(-150%);
            background: var(--f1-red);
            color: white;
            padding: 0.75rem 1.5rem;
            font-weight: 900;
            font-style: italic;
            text-transform: uppercase;
            font-size: 0.7rem;
            z-index: 1000;
            transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            white-space: nowrap;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #toast.visible { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body class="loading">

    <div id="toast">System Alert</div>

    <!-- Navigation -->
    <aside class="sidebar" id="sidebar">
        <div class="p-6 mb-8 hidden lg:block">
            <h1 class="text-xl font-black italic tracking-tighter text-white">F1 <span class="text-red-600">HUB</span></h1>
            <p class="text-[9px] text-gray-500 tracking-[3px] uppercase mt-1">Telemetry System</p>
        </div>

        <nav class="flex flex-1 flex-col lg:gap-1 lg:px-2">
            <div class="sidebar-item active" id="nav-overview" onclick="switchView('overview')">
                <svg class="w-5 h-5 lg:mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                <span class="label">Overview</span>
            </div>
            <div class="sidebar-item" id="nav-courses" onclick="switchView('courses')">
                <svg class="w-5 h-5 lg:mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                <span class="label">Courses</span>
            </div>
            <div class="sidebar-item" id="nav-motivation" onclick="switchView('motivation')">
                <svg class="w-5 h-5 lg:mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                <span class="label">Motivation</span>
            </div>
            <div class="sidebar-item mt-auto text-red-500 hover:text-white" onclick="handleLogout()">
                <svg class="w-5 h-5 lg:mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                <span class="label">Logout</span>
            </div>
        </nav>
    </aside>

    <div class="main-content">
        <!-- Header -->
        <header class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-6">
            <div>
                <p class="text-[10px] text-red-600 font-black tracking-widest uppercase mb-1">Status: Active</p>
                <h2 class="text-2xl md:text-3xl font-black italic">HELLO, <span id="driver-name" class="text-white">DRIVER</span></h2>
                <p class="text-[9px] text-gray-500 uppercase tracking-widest mt-1" id="user-display">CONNECTING...</p>
            </div>
            
            <div class="grid grid-cols-2 gap-3 w-full md:w-auto">
                <div class="bg-zinc-900/50 p-3 border-l-2 border-red-600">
                    <p class="text-[8px] text-gray-500 uppercase mb-1">Telemetry Time</p>
                    <p class="text-xs font-bold font-mono" id="current-time">00:00:00</p>
                </div>
                <div class="bg-zinc-900/50 p-3 border-l-2 border-green-600">
                    <p class="text-[8px] text-gray-500 uppercase mb-1">Grid Status</p>
                    <p class="text-[10px] font-black text-green-500">PEAK READY</p>
                </div>
            </div>
        </header>

        <!-- Overview -->
        <section id="section-overview" class="view-section active">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="card md:col-span-2 flex flex-col justify-center bg-gradient-to-r from-zinc-900 to-black">
                    <p class="text-[9px] uppercase text-red-600 font-black mb-2 tracking-[2px]">Season Countdown</p>
                    <div id="race-countdown" class="text-2xl md:text-4xl font-black tabular-nums tracking-tighter italic">00:00:00:00</div>
                    <p class="text-[7px] text-gray-600 uppercase tracking-[4px] mt-2">Days / Hrs / Min / Sec</p>
                </div>
                <div class="card border-l-4 border-red-600">
                    <p class="text-[9px] uppercase text-gray-500 font-bold mb-3 tracking-widest">Inspiration</p>
                    <p id="daily-motivation-snippet" class="motivation-sinhala text-xs leading-relaxed italic text-white/80 line-clamp-3">Loading...</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                <div class="card">
                    <h3 class="font-bold uppercase text-[10px] mb-4 text-gray-400 tracking-widest">Assigned Modules</h3>
                    <div class="space-y-3" id="active-modules-list">
                        <div class="animate-pulse bg-zinc-800 h-10 w-full rounded"></div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="font-bold uppercase text-[10px] mb-4 text-gray-400 tracking-widest">Paddock Notices</h3>
                    <div class="space-y-3" id="track-alerts-list">
                        <div class="animate-pulse bg-zinc-800 h-20 w-full rounded"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Courses -->
        <section id="section-courses" class="view-section">
            <div class="flex items-center gap-3 mb-6">
                <h2 class="text-lg font-black italic uppercase">Training Programs</h2>
                <div class="h-[1px] flex-1 bg-zinc-800"></div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4" id="courses-container">
                <!-- Course Cards injected here -->
            </div>
        </section>

        <!-- Motivation -->
        <section id="section-motivation" class="view-section">
            <div class="max-w-3xl mx-auto">
                <div class="card border-t-4 border-red-600 py-12 px-8 text-center bg-zinc-900/20">
                    <div class="mb-10">
                        <svg class="w-8 h-8 text-red-600 mx-auto mb-6 opacity-50" fill="currentColor" viewBox="0 0 24 24"><path d="M14.017 21L14.017 18C14.017 16.8954 14.9124 16 16.017 16H19.017C19.5693 16 20.017 15.5523 20.017 15V9C20.017 8.44772 19.5693 8 19.017 8H16.017C14.9124 8 14.017 7.10457 14.017 6V3L14.017 2H12.017V3L12.017 6C12.017 8.20914 10.2261 10 8.017 10H5.017C4.46472 10 4.017 10.4477 4.017 11V17C4.017 17.5523 4.46472 18 5.017 18H8.017C9.12157 18 10.017 18.8954 10.017 20V21L10.017 22H12.017V21L12.017 20C12.017 17.7909 13.8079 16 16.017 16V17C16.017 19.2091 17.8079 21 20.017 21H21.017V19H20.017C18.9124 19 18.017 18.1046 18.017 17V16L19.017 16C20.6739 16 22.017 14.6569 22.017 13V8C22.017 6.34315 20.6739 5 19.017 5H18.017V4C18.017 2.34315 16.6739 1 15.017 1H11.017C9.36015 1 8.017 2.34315 8.017 4V5H7.017C5.36015 5 4.017 6.34315 4.017 8V13C4.017 14.6569 5.36015 16 7.017 16H8.017V17C8.017 18.6569 6.67386 20 5.017 20H4.017V22H5.017C7.22614 22 9.017 20.2091 9.017 18V17L9.017 16H8.017V11H11.017V21H14.017V11H17.017V16L18.017 16L18.017 21H14.017Z"/></svg>
                        <p id="motivation-main-text" class="motivation-sinhala text-xl md:text-2xl font-bold leading-relaxed text-white">...</p>
                    </div>
                    <div class="flex flex-col items-center gap-4 pt-8 border-t border-white/5">
                        <p id="motivation-date" class="text-[9px] font-black tracking-[4px] text-gray-500 uppercase">-- --- ----</p>
                        <button onclick="refreshMotivation()" class="f1-btn max-w-xs">Next Telemetry Insight</button>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        const GOOGLE_SHEET_ID = '1HLQxJv32eo-EloTtdZhw5ZhEWIXuhMOI7OAKsqG-dfI';
        const GOOGLE_API_KEY = 'AIzaSyD3sts8y_s8M8L2Y66Gz0ICY_9SY-VmoEo';
        const COURSES_SHEET = 'courses';
        const NOTICES_SHEET = 'notice';

        const sinhalaQuotes = [
            "ජයග්‍රහණය පවතින්නේ උත්සාහය අත් නොහරින පුද්ගලයා සතුවයි.",
            "අද ඔබ කරන සුළු කැපවීම හෙට දවසේ විශාල ජයග්‍රහණයක් වනු ඇත.",
            "කාලය කළමනාකරණය කරගන්න, එවිට ලෝකය ඔබව සොයා එනු ඇත.",
            "සිහින දැකීම නවත්වන්න එපා, මන්ද සිහින යනු අනාගතයේ මාලිමාවයි.",
            "වෙනස ආරම්භ විය යුත්තේ ඔබෙන්මයි.",
            "ජීවිතයේ අභියෝග යනු ඔබව ශක්තිමත් කරන මෙවලම් මිස බාධක නොවේ.",
            "අසාර්ථකත්වය යනු නැවත ආරම්භ කිරීමට ලැබුණු තවත් එක් අවස්ථාවක් පමණි."
        ];

        const SUPABASE_URL = 'https://ogfmimplmjzhqzeeexae.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9nZm1pbXBsbWp6aHF6ZWVleGFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwNTgzNzcsImV4cCI6MjA4NjYzNDM3N30.l8j1VC7-Zt88UGRkclBd-dNyLZsHg2DuY_9FRRW311o';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        window.switchView = function(viewName) {
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            const targetSection = document.getElementById(`section-${viewName}`);
            const targetNav = document.getElementById(`nav-${viewName}`);
            if (targetSection) targetSection.classList.add('active');
            if (targetNav) targetNav.classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.refreshMotivation = function() {
            const el = document.getElementById('motivation-main-text');
            if (el) {
                const rand = Math.floor(Math.random() * sinhalaQuotes.length);
                el.innerText = sinhalaQuotes[rand];
            }
        };

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.innerText = message;
            toast.classList.add('visible');
            setTimeout(() => toast.classList.remove('visible'), 3000);
        }

        window.enterSimulation = function(courseId, courseName) {
            showToast(`INITIATING SYSTEM: ${courseName.toUpperCase()}`);
            localStorage.setItem('selectedCourseId', courseId);
            localStorage.setItem('selectedCourseName', courseName);
            setTimeout(() => { window.location.href = 'courses.html'; }, 800);
        };

        window.handleLogout = async function() {
            try {
                await supabaseClient.auth.signOut();
                window.location.href = 'login.html';
            } catch (err) {
                window.location.href = 'login.html';
            }
        };

        async function checkUserSession() {
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            if (error || !session) {
                window.location.href = 'login.html';
                return;
            }
            const user = session.user;
            const name = user.user_metadata.full_name || user.email.split('@')[0];
            document.getElementById('user-display').innerText = `ID: ${user.email.toUpperCase()}`;
            document.getElementById('driver-name').innerText = name.toUpperCase();
            document.body.classList.remove('loading');
            fetchCoursesFromSheet();
            fetchNoticesFromSheet();
            initMotivation();
            startClocks();
        }

        function initMotivation() {
            const now = new Date();
            const dayOfYear = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
            const quote = sinhalaQuotes[dayOfYear % sinhalaQuotes.length];
            document.getElementById('daily-motivation-snippet').innerText = quote;
            document.getElementById('motivation-main-text').innerText = quote;
            document.getElementById('motivation-date').innerText = now.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).toUpperCase();
        }

        async function fetchCoursesFromSheet() {
            const container = document.getElementById('courses-container');
            const moduleList = document.getElementById('active-modules-list');
            try {
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEET_ID}/values/${COURSES_SHEET}!A2:E100?key=${GOOGLE_API_KEY}`);
                const data = await response.json();
                if (!data.values) throw new Error('No data');

                container.innerHTML = '';
                moduleList.innerHTML = '';

                data.values.forEach((row, index) => {
                    const [id, name, instructor, description, imageUrl] = row;
                    const safeName = (name || 'Untitled').replace(/'/g, "\\'");
                    
                    const card = document.createElement('div');
                    card.className = 'course-card';
                    card.innerHTML = `
                        <div class="course-img-container">
                             <img src="${imageUrl || 'https://images.unsplash.com/photo-1544654803-b69110bb8154?auto=format&fit=crop&q=80&w=800'}" 
                             class="course-img" alt="${name}" 
                             onerror="this.src='https://images.unsplash.com/photo-1503376780353-7e6692767b70?auto=format&fit=crop&q=80&w=800'">
                        </div>
                        <div class="p-5 flex flex-col flex-1">
                            <p class="text-[7px] text-red-600 font-black mb-1 uppercase tracking-widest">ID: ${id}</p>
                            <h3 class="text-sm font-black italic mb-2 uppercase">${name || 'UNTITLED'}</h3>
                            <p class="text-[10px] text-gray-500 mb-4 flex-1 line-clamp-2">${description || 'No description provided.'}</p>
                            <button class="f1-btn mt-auto" onclick="enterSimulation('${id}', '${safeName}')">Enter Simulation</button>
                        </div>
                    `;
                    container.appendChild(card);

                    if (index < 4) {
                        const moduleItem = document.createElement('div');
                        moduleItem.className = 'flex items-center justify-between p-3 bg-zinc-900/40 rounded border border-white/5';
                        moduleItem.innerHTML = `
                            <div class="flex items-center gap-3">
                                <div class="w-1 h-4 bg-red-600"></div>
                                <span class="text-[10px] font-bold uppercase">${name}</span>
                            </div>
                            <button class="text-[8px] bg-red-600 px-3 py-1 font-black hover:bg-white hover:text-red-600 transition-colors uppercase italic" onclick="enterSimulation('${id}', '${safeName}')">Launch</button>
                        `;
                        moduleList.appendChild(moduleItem);
                    }
                });
            } catch (err) {
                container.innerHTML = `<p class="col-span-full text-center text-red-600 text-[10px] font-bold py-10">TELEMETRY OFFLINE</p>`;
            }
        }

        async function fetchNoticesFromSheet() {
            const alertsList = document.getElementById('track-alerts-list');
            try {
                const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${GOOGLE_SHEET_ID}/values/${NOTICES_SHEET}!A2:D100?key=${GOOGLE_API_KEY}`);
                const data = await response.json();
                if (!data.values || data.values.length === 0) {
                    alertsList.innerHTML = '<p class="text-[10px] text-gray-500">NO ACTIVE ALERTS</p>';
                    return;
                }
                alertsList.innerHTML = '';
                [...data.values].reverse().slice(0, 3).forEach(row => {
                    const [title, content, link, timestamp] = row;
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'p-3 bg-zinc-900/30 rounded border-l-2 border-yellow-500 hover:bg-zinc-900/50 transition-all';
                    alertDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <p class="text-[9px] font-black uppercase tracking-tighter">${title || 'NOTICE'}</p>
                            <span class="text-[7px] text-gray-600 font-bold">${timestamp || ''}</span>
                        </div>
                        <p class="text-[10px] text-gray-400 line-clamp-2">${content || ''}</p>
                    `;
                    alertsList.appendChild(alertDiv);
                });
            } catch (err) {
                alertsList.innerHTML = '<p class="text-[10px] text-red-600 font-bold">ALERTS OFFLINE</p>';
            }
        }

        function startClocks() {
            function update() {
                const now = new Date();
                document.getElementById('current-time').innerText = now.toLocaleTimeString('en-GB', { hour12: false });
                const targetDate = new Date('2026-08-10T08:30:00');
                const diff = targetDate - now;
                if (diff > 0) {
                    const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((diff % (1000 * 60)) / 1000);
                    document.getElementById('race-countdown').innerText = `${String(d).padStart(2, '0')}:${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                } else {
                    document.getElementById('race-countdown').innerText = "SESSION LIVE";
                }
            }
            setInterval(update, 1000);
            update();
        }

        window.addEventListener('load', checkUserSession);
    </script>
</body>
</html>
